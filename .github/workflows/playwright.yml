name: Run Playwright Tests on Push

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore

      - name: Publish Blazor app
        run: dotnet publish BlazorApp1/BlazorApp1.csproj -c Release -o publish

      - name: Install Playwright CLI
        run: dotnet tool install --global Microsoft.Playwright.CLI

      - name: Install Playwright browsers
        run: playwright install

      - name: Install wait-on
        run: npm install -g wait-on

      - name: Run Blazor app and check if it started
        run: |
          # Start the app in a background PowerShell job
          Start-Job -ScriptBlock {
          dotnet run --project BlazorApp1/BlazorApp1.csproj --urls=http://localhost:5000 > blazor.log 2>&1
          } | Out-Null

          # Wait and try to hit the port
          $maxRetries = 10
          $delaySeconds = 5
          $url = "http://localhost:5000"

          for ($i = 0; $i -lt $maxRetries; $i++) {
          try {
            $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 3
            if ($response.StatusCode -eq 200) {
              Write-Host "Blazor app is up and responding."
              break
            }
          } catch {
           Write-Host "Attempt $($i + 1): App not ready yet..."
          }
          Start-Sleep -Seconds $delaySeconds
          }

          if ($i -eq $maxRetries) {
            Write-Host "::error::Blazor app did not start in time."
            type blazor.log
          exit 1
          }

          # Optional: print log for confirmation
          Write-Host "--- Blazor Startup Log ---"
          type blazor.log
        shell: pwsh

      - name: Wait for server to start
        run: Start-Sleep -Seconds 50
        shell: pwsh

      - name: Run Playwright Tests
        run: dotnet test
